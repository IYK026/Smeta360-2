# üöÄ –û—Ç—á–µ—Ç –ø–æ –®–∞–≥—É 4: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫—ç—à —á—Ç–µ–Ω–∏–π (Redis)

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 4.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ‚úÖ
```bash
npm i ioredis  # –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Redis –∫–ª–∏–µ–Ω—Ç
sudo apt install redis-server  # –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Redis Server
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ .env:**
```env
REDIS_URL=redis://localhost:6379
CACHE_ENABLED=true             # –µ–¥–∏–Ω—ã–π –≥–ª–∞–≤–Ω—ã–π —Ñ–ª–∞–≥
CACHE_MATERIALS=true           # —Ç–æ–Ω–∫–∏–π —Ñ–ª–∞–≥ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤  
CACHE_WORKS=true               # —Ç–æ–Ω–∫–∏–π —Ñ–ª–∞–≥ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç
CACHE_TTL_MATERIALS=600        # 10 –º–∏–Ω—É—Ç TTL
CACHE_TTL_WORKS=600            # 10 –º–∏–Ω—É—Ç TTL
```

### 4.2 Redis –∫–ª–∏–µ–Ω—Ç —Å —Ñ–æ–ª–ª–±—ç–∫–æ–º ‚úÖ
**–§–∞–π–ª**: `server/cache/redisClient.js`
- ‚úÖ –õ–µ–Ω–∏–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (lazyConnect: true)
- ‚úÖ –ê–≤—Ç–æ–ø–∞–π–ø–ª–∞–π–Ω–∏–Ω–≥ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ñ–æ–ª–ª–±—ç–∫ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

### 4.3 –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è ‚úÖ
**–§–∞–π–ª**: `server/cache/cache.js`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `cacheGetOrSet()` —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç cache stampede
- ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `cacheInvalidateByPrefix()`
- ‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π (v1) –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞ (hits/misses/errors/sets)
- ‚úÖ –ù–µ–π–º—Å–ø–µ–π—Å –∫–ª—é—á–µ–π `smeta360:v1:`

### 4.4 –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ ‚úÖ

#### –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
- **–ö–ª—é—á–∏ –∫—ç—à–∞**: `materials:q={search}:p={page}:l={limit}`
- **TTL**: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)
- **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è**: search, page, limit
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**: `{data, pagination, lastUpdated}`

#### –†–∞–±–æ—Ç—ã
- **–ö–ª—é—á–∏ –∫—ç—à–∞**: `works:q={search}:p={page}:l={limit}`
- **TTL**: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)
- **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è**: search, page, limit  
- **JOINs**: –≤–∫–ª—é—á–µ–Ω—ã —Å–≤—è–∑–∏ —Å phases, stages, substages

### 4.5 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è ‚úÖ
- ‚úÖ **POST /api/materials** ‚Üí –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è `materials:*`
- ‚úÖ **PUT /api/materials/:id** ‚Üí –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è `materials:*`
- ‚úÖ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è (catch errors)
- ‚úÖ SCAN-based —É–¥–∞–ª–µ–Ω–∏–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

### 4.6 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚úÖ
**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
- ‚úÖ `GET /api/cache/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞ –∏ Redis
- ‚úÖ `DELETE /api/cache` - –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø–∞–º—è—Ç–∏ Redis

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π 1: –§–∏—á–µ—Ñ–ª–∞–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
```bash
# CACHE_MATERIALS=true
curl /api/cache/stats | jq '.config.materials'  # true

# CACHE_MATERIALS=false  
curl /api/cache/stats | jq '.config.materials'  # false
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –§–ª–∞–≥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–ø—Ä–∞–≤–ª—è—é—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π 2: –ö–ª—é—á–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```bash
redis-cli --raw KEYS "smeta360:v1:materials*"
# smeta360:v1:materials:q=test:p=1:l=5
# smeta360:v1:materials:q=:p=1:l=5
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π 3: –•–∏—Ç—ã –∫—ç—à–∞ –∑–∞–º–µ—Ç–Ω—ã
```bash
# –•–æ–ª–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –ë–î)
time curl /api/materials?search=test&limit=5  # 859ms

# –¢—ë–ø–ª—ã–π –∑–∞–ø—Ä–æ—Å (–∏–∑ –∫—ç—à–∞)  
time curl /api/materials?search=test&limit=5  # 75ms
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **91% —É—Å–∫–æ—Ä–µ–Ω–∏–µ** (859ms ‚Üí 75ms)

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π 4: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
# –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞
redis-cli KEYS "smeta360:v1:materials*"  # 1 –∫–ª—é—á

# POST /api/materials 
curl -X POST /api/materials -d '{"name":"Test"}'

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è  
redis-cli KEYS "smeta360:v1:materials*"  # 0 –∫–ª—é—á–µ–π
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π 5: –§–æ–ª–ª–±—ç–∫ –±–µ–∑–æ–ø–∞—Å–µ–Ω
- **Redis –¥–æ—Å—Ç—É–ø–µ–Ω**: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
- **CACHE_MATERIALS=false**: –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –≤ –ë–î (492-1522ms)  
- **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –∫ –ë–î
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ª—é–±—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **Cache Hit Ratio**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: –¥–æ 91% (859ms ‚Üí 75ms)
- **TTL**: 10 –º–∏–Ω—É—Ç - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–≤–µ–∂–µ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- **–ü–∞–º—è—Ç—å Redis**: ~1MB, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π
```
smeta360:v1:materials:q={search}:p={page}:l={limit}
smeta360:v1:works:q={search}:p={page}:l={limit}  
```
- **–ù–µ–π–º—Å–ø–µ–π—Å**: smeta360 (–∏–∑–æ–ª—è—Ü–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
- **–í–µ—Ä—Å–∏—è**: v1 (–º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞ v2)
- **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
- **Cache Stampede Protection**: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –ë–î
- **Graceful Degradation**: –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å Redis ‚Üí fallback –∫ –ë–î
- **Structured Logging**: –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∫—ç—à–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- **Error Isolation**: –æ—à–∏–±–∫–∏ –∫—ç—à–∞ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
```json
{
  "cache": {
    "hits": 3,
    "misses": 3, 
    "errors": 0,
    "sets": 3
  },
  "redis": {
    "available": true,
    "status": "connected"
  }
}
```

### Redis –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **–ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–∞–º—è—Ç—å**: 1.04MB
- **–ö–ª—é—á–∏ –≤ –±–∞–∑–µ**: 1 –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª—é—á
- **TTL**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è

## üéØ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–π –®–∞–≥–∞ 4

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ |
|----------|--------|---------------|
| ‚úÖ –§–∏—á–µ—Ñ–ª–∞–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç | **–ì–û–¢–û–í** | `CACHE_MATERIALS=false` –æ—Ç–∫–ª—é—á–∞–µ—Ç –∫—ç—à |
| ‚úÖ –ö–ª—é—á–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã | **–ì–û–¢–û–í** | –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ |  
| ‚úÖ –•–∏—Ç—ã –∑–∞–º–µ—Ç–Ω—ã | **–ì–û–¢–û–í** | 859ms ‚Üí 75ms (91% —É—Å–∫–æ—Ä–µ–Ω–∏–µ) |
| ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç | **–ì–û–¢–û–í** | POST/PUT –æ—á–∏—â–∞—é—Ç –∫—ç—à |
| ‚úÖ –§–æ–ª–ª–±—ç–∫ –±–µ–∑–æ–ø–∞—Å–µ–Ω | **–ì–û–¢–û–í** | –ë–µ–∑ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ |

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–∞–º

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í**

–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞:
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ì—Ä–∞–Ω—É–ª—è—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–∏—á–∞-—Ñ–ª–∞–≥–∏  
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ü–æ–ª–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
- 91% —É—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–ª–µ–¥—É—é—â–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis Cluster –¥–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è warming –∫—ç—à–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---
*–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è*: 01.10.2025  
*–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏*: ~30 –º–∏–Ω—É—Ç  
*–£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏*: –î–æ 91% –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤*