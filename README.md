# 📊 SMETA360 - Система строительного сметообразования

> Современное веб-приложение для создания и управления строительными сметами на базе React 18 + Node.js + PostgreSQL

![Project Status](https://img.shields.io/badge/Status-Development-orange)
![Version](https://img.shields.io/badge/Version-2.0.0-blue)
![Tech Stack](https://img.shields.io/badge/Tech-React%20%7C%20Node.js%20%7C%20PostgreSQL-green)

---

## 🎯 О проекте

SMETA360 - это полнофункциональная система для автоматизации процессов сметообразования в строительстве. Система предоставляет современный интерфейс для создания смет, управления каталогами работ и материалов, а также управления строительными проектами.

### ✨ Ключевые возможности

- 📋 **Создание смет** - Интерактивный расчет стоимости работ с автоматическим подсчетом материалов
- 💰 **Сметы заказчика** - Полная система управления сметами с коэффициентами, историей изменений и шаблонами
- 🏗️ **Управление проектами** - Создание, хранение и управление строительными проектами  
- 📚 **Каталоги данных** - 4,048+ записей работ и материалов с изображениями
- 🏢 **Параметры объекта** - Управление помещениями, конструктивными элементами и инженерными системами
- 👥 **Мультитенантность** - Изоляция данных по организациям через RLS политики
- 🔐 **Безопасность** - JWT аутентификация с ротацией токенов и 5-уровневой ролевой системой
- 📱 **Отзывчивый дизайн** - Material-UI + Ant Design для современного UX

---

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    SMETA360 ARCHITECTURE                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🎨 FRONTEND (React 18)        🌐 BACKEND (Node.js)        │
│  ├── Vite 7.0.4               ├── Express 4.18.2          │
│  ├── Material-UI + Ant Design ├── JWT Authentication       │  
│  ├── React Router 7.6.3       ├── Multi-tenant Context    │
│  └── Lazy Loading Routes      └── CORS + Rate Limiting     │
│                                                             │
│  ────────────────── HTTP API ──────────────────────        │
│                                                             │
│  💾 DATABASE (PostgreSQL 17.6)                            │
│  ├── 11 Tables, 4,048+ Records                            │
│  ├── Row Level Security (RLS)                             │
│  ├── Aiven Cloud Hosting                                  │
│  └── Connection Pooling                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 Быстрый старт

### Предварительные требования

- **Node.js** 18+ 
- **PostgreSQL** 12+
- **Git**
- **Yarn** 4.9.1 (рекомендуется) или npm

### 1. Клонирование и установка

```bash
# Клонируйте репозиторий
git clone <repository-url>
cd SMETA360-1-Complete

# Установите зависимости
npm install --legacy-peer-deps

# Установите серверные зависимости  
cd server && npm install && cd ..
```

### 2. Настройка окружения

Создайте файлы конфигурации:

```bash
# Скопируйте шаблоны
cp server/.env.template server/.env

# Отредактируйте server/.env
nano server/.env
```

**Пример server/.env:**
```env
DATABASE_URL=postgresql://username:password@hostname:port/database
JWT_SECRET=your-super-secure-jwt-secret-here
BCRYPT_SALT_ROUNDS=10
PORT=3001
```

### 3. Настройка базы данных

```sql
-- Создайте базу данных PostgreSQL
CREATE DATABASE smeta360;

-- Настройка выполнится автоматически при первом запуске сервера
-- Или выполните SQL скрипт вручную:
\i create_works_ref_database.sql
```

### 4. Запуск приложения

#### Development режим:

```bash
# Вариант 1: Запуск всего одной командой
npm run start:all

# Вариант 2: Запуск в отдельных терминалах
# Terminal 1 - Backend (localhost:3001)
cd server && node index.js

# Terminal 2 - Frontend (localhost:3000)  
npm start
```

Приложение будет доступно по адресу: **http://localhost:3000**

---

## 🛠️ Управление сервером

### Запуск серверов

```bash
# Запустить оба сервера одновременно (рекомендуется)
npm run start:all

# Запустить только backend на порту 3001
cd server && node index.js

# Запустить только frontend на порту 3000
npm start
```

### Остановка серверов

```bash
# Остановка через Ctrl+C в терминале где запущены серверы
# Или принудительная остановка:

# Найти процессы на портах
lsof -i :3000,3001

# Остановить все Node.js процессы (осторожно!)
pkill -f node

# Остановить конкретный процесс по PID
kill -9 <PID>
```

### Освобождение портов

```bash
# Проверить какие процессы используют порты 3000 и 3001
lsof -i :3000
lsof -i :3001

# Освободить порт 3000 (frontend)
lsof -ti:3000 | xargs kill -9

# Освободить порт 3001 (backend)
lsof -ti:3001 | xargs kill -9

# Освободить оба порта одной командой
lsof -ti:3000,3001 | xargs kill -9

# Проверить что порты свободны
lsof -i :3000,3001 || echo "Порты 3000 и 3001 свободны"
```

### Диагностика проблем

```bash
# Проверить запущенные Node.js процессы
ps aux | grep -E "(node|vite)" | grep -v grep

# Проверить статус портов
netstat -tulpn | grep -E ":300[01]"

# Проверить логи сервера
# (логи выводятся в терминал где запущен сервер)

# Тест подключения к API
curl http://localhost:3001/api/test

# Тест доступности frontend
curl http://localhost:3000
```

### Полезные команды

```bash
# Перезапуск после изменений в коде
# Frontend перезапускается автоматически (hot reload)
# Backend нужно перезапускать вручную:
cd server && node index.js

# Очистка кэша npm (если проблемы с зависимостями)
npm cache clean --force

# Переустановка зависимостей
rm -rf node_modules package-lock.json
npm install

# Переустановка серверных зависимостей  
cd server && rm -rf node_modules package-lock.json && npm install
```

---

## 📦 Структура проекта

```
SMETA360-1-Complete/
├── 📁 src/                     # React Frontend
│   ├── 📁 api/                 # API сервисы  
│   │   ├── auth.js            # Аутентификация
│   │   └── database.js        # CRUD операции
│   ├── 📁 components/         # Переиспользуемые компоненты
│   ├── 📁 pages/              # Страницы приложения
│   │   ├── 📁 calculations/    # Расчет смет
│   │   ├── 📁 directories/     # Каталоги работ/материалов
│   │   ├── 📁 projects/        # Управление проектами
│   │   └── 📁 auth/           # Страницы авторизации
│   └── 📁 routes/             # Маршрутизация
│
├── 📁 server/                  # Node.js Backend  
│   ├── index.js               # Главный сервер (1,296 строк)
│   ├── database.js            # Подключение к PostgreSQL
│   ├── config.js              # Конфигурация
│   ├── 📁 services/           # Бизнес-логика
│   │   └── tokenService.js    # JWT токены
│   ├── 📁 middleware/         # Express middleware
│   │   └── tenantContext.js   # Мультитенантность  
│   └── 📁 controllers/        # API контроллеры
│
├── 📁 .github/workflows/      # CI/CD
│   └── prod.yml               # GitHub Actions
├── package.json               # Frontend зависимости
├── vite.config.mjs           # Vite конфигурация
└── README.md                 # Эта документация
```

---

## 🔧 API Reference

### Аутентификация

```http
POST   /api/auth/register    # Регистрация пользователя
POST   /api/auth/login       # Вход в систему  
POST   /api/auth/logout      # Выход из системы
GET    /api/auth/me          # Текущий пользователь
POST   /api/auth/refresh     # Обновление токена
```

### Проекты

```http
GET    /api/projects         # Список проектов пользователя
POST   /api/projects         # Создать новый проект
GET    /api/projects/:id     # Получить проект
PUT    /api/projects/:id     # Обновить проект
DELETE /api/projects/:id     # Удалить проект
```

### Каталоги

```http
GET    /api/works           # Справочник работ
GET    /api/materials       # Справочник материалов  
GET    /api/work-materials  # Связи работ и материалов
POST   /api/estimates       # Создать смету
GET    /api/estimates/:id   # Получить смету
```

### Сметы заказчика

```http
GET    /api/customer-estimates                    # Список смет заказчика
POST   /api/customer-estimates                    # Создать смету заказчика
GET    /api/customer-estimates/:id                # Получить смету по ID
PUT    /api/customer-estimates/:id                # Обновить смету
DELETE /api/customer-estimates/:id                # Удалить смету
GET    /api/customer-estimates/:estimateId/items  # Элементы сметы
POST   /api/customer-estimates/:estimateId/items  # Добавить элемент в смету
```

### Параметры объекта

```http
GET    /api/projects/:projectId/object-parameters           # Параметры объекта
POST   /api/projects/:projectId/object-parameters           # Создать параметры
GET    /api/object-parameters/:id/rooms                     # Помещения объекта
POST   /api/object-parameters/:id/rooms                     # Добавить помещение
GET    /api/object-parameters/:id/constructive-elements     # Конструктивные элементы
POST   /api/object-parameters/:id/constructive-elements     # Добавить элемент
GET    /api/object-parameters/:id/engineering-systems       # Инженерные системы
POST   /api/object-parameters/:id/engineering-systems       # Добавить систему
```

### Служебные

```http  
GET    /api/health          # Статус сервера
GET    /api/health/db       # Статус базы данных
GET    /api/test           # Тестовый endpoint
```

**Аутентификация:** Большинство endpoints требует JWT токен в заголовке:
```http
Authorization: Bearer <jwt_token>
```

---

## 🗄️ База данных

### Схема основных таблиц

```sql
-- Пользователи и аутентификация
auth_users             # Пользователи системы с ролями 
user_sessions          # Активные сессии
user_roles             # Роли пользователей
user_role_assignments  # Назначение ролей

-- Справочные данные
materials              # Каталог материалов (4,048+ записей)
works_ref              # Каталог работ  
work_materials         # Расход материалов на работы

-- Проекты и параметры объектов
construction_projects     # Строительные проекты
object_parameters        # Основные параметры объектов
project_rooms           # Помещения объектов
constructive_elements   # Конструктивные элементы
engineering_systems     # Инженерные системы

-- Сметы заказчика
customer_estimates         # Основные сметы заказчика
customer_estimate_items    # Элементы смет (работы, материалы)
customer_estimate_history  # История изменений смет
customer_estimate_templates # Шаблоны смет

-- Система аудита и безопасности
audit_log              # Журнал всех изменений
permissions            # Разрешения системы
role_permissions       # Связь ролей и разрешений
```

### Характеристики БД

- **Записей:** 4,048+ в каталогах материалов и работ
- **Таблиц:** 18 основных таблиц + системные
- **Размер:** ~15MB с новыми системами  
- **Хостинг:** Aiven PostgreSQL Cloud
- **Безопасность:** Multi-tenant архитектура с ролевой системой
- **Индексы:** Оптимизированы для быстрого поиска и JOIN операций
- **Аудит:** Полное логирование всех изменений данных

---

## 🔒 Безопасность

### Реализованные меры

✅ **Аутентификация:** JWT токены с refresh rotation  
✅ **Авторизация:** 5-уровневая ролевая система (super_admin, admin, project_manager, estimator, viewer)
✅ **SQL Injection:** Параметризованные запросы для всех операций 
✅ **Мультитенантность:** Изоляция данных по tenant_id с проверкой прав доступа
✅ **Хэширование:** bcrypt для паролей (10 rounds)  
✅ **CORS:** Настроен для frontend домена
✅ **Аудит:** Полное логирование действий пользователей в audit_log
✅ **Data Isolation:** Пользователи видят только свои данные (кроме администраторов)  

### Известные уязвимости ⚠️

- **XSS Risk:** JWT токены в localStorage  
- **Missing Rate Limiting:** Нет защиты от brute force  
- **Weak Default Secrets:** В development окружении  
- **No Security Headers:** CSP, HSTS не настроены  

**См. детальный анализ безопасности в [техническом отчете](REPORT_SMETA360_20250928.md#7-безопасность)**

---

## 🆕 Новые системы (Сентябрь 2025)

### 💰 Система смет заказчика

Полнофункциональная система управления коммерческими предложениями и сметами для заказчиков:

**Основные возможности:**
- ✅ Создание, редактирование и удаление смет
- ✅ Управление элементами смет (работы, материалы, пользовательские позиции)
- ✅ **Блочное копирование** - автоматическое копирование данных из "Расчет сметы" в "Смета заказчика" блоками (работа + связанные материалы)
- ✅ **Автоматическое копирование** - без модальных окон, копирование происходит в активную смету
- ✅ **Группировка по блокам** - корректное отображение данных блоками с использованием reference_id
- ✅ **Управление активной сметой** - система автоматически отслеживает активную смету через localStorage
- ✅ Применение коэффициентов (региональные, сложности, срочности)
- ✅ История изменений с полным аудитом действий
- ✅ Система шаблонов для типовых смет
- ✅ 5-уровневая ролевая система доступа

**API эндпоинты:** 11 endpoints для полного управления
**Новые функции:** Полная интеграция с системой расчета смет
**Документация:** [CUSTOMER_ESTIMATES_API.md](CUSTOMER_ESTIMATES_API.md)

### 🏢 Система параметров объекта

Комплексная система для описания строительных объектов:

**Модули системы:**
- ✅ **Помещения** - управление комнатами с характеристиками
- ✅ **Конструктивные элементы** - стены, перекрытия, фундаменты
- ✅ **Инженерные системы** - отопление, водопровод, электрика, вентиляция

**API эндпоинты:** 16 endpoints с полной ролевой системой
**Документация:** [OBJECT_PARAMETERS_API.md](OBJECT_PARAMETERS_API.md)

### 🔐 Расширенная система безопасности

**Роли пользователей:**
- **super_admin** - Полный доступ ко всей системе
- **admin** - Управление в рамках организации
- **project_manager** - Управление проектами и сметами
- **estimator** - Создание и редактирование смет
- **viewer** - Только просмотр данных

**Многоуровневая защита:**
- Multi-tenant архитектура с изоляцией по tenant_id
- Проверка прав доступа на уровне каждого API endpoint
- Полный аудит всех действий пользователей
- Автоматическое логирование изменений данных

---

## 🧪 Тестирование  

### Текущий статус

❌ **Unit Tests:** Отсутствуют  
❌ **Integration Tests:** Отсутствуют  
❌ **E2E Tests:** Отсутствуют  
⚠️ **Manual Testing:** Базовые тестовые страницы  

### Тестовые утилиты

- `src/pages/test/TestAuth.jsx` - UI тест аутентификации  
- `src/pages/extra-pages/database-test.jsx` - Тест БД соединения  
- `test-api.js` - Примитивный API тест  

**Для production готовности критически необходимо внедрение автоматизированного тестирования.**

---

## 🚀 Деплой

### CI/CD Pipeline

Настроен GitHub Actions для автоматического деплоя:

```yaml
# .github/workflows/prod.yml
- Trigger: push to master / merged PR
- Node.js: 22
- Build: Yarn v4.9.1  
- Deploy: SSH to production server
```

### Manual Deploy

```bash
# Сборка для production
npm run build

# Сборка backend
cd server && npm install --production

# Настройка переменных окружения
cp server/.env.template server/.env
# Отредактируйте production значения

# Запуск в production
cd server && node index.js
```

---

## 📊 Мониторинг и поддержка

### Health Checks

```bash
# Проверка статуса сервера
curl http://localhost:3001/api/health

# Проверка подключения к БД  
curl http://localhost:3001/api/health/db

# Тестовый endpoint
curl http://localhost:3001/api/test
```

### Логи и отладка

```bash
# Server логи
cd server && node index.js

# Database queries логируются в консоль
# JWT операции отображаются с деталями
# Ошибки подключения к БД с fallback информацией
```

---

## 🤝 Разработка

### Процесс разработки

1. **Fork** репозиторий
2. Создайте **feature branch**: `git checkout -b feature/amazing-feature`  
3. **Commit** изменения: `git commit -m 'Add amazing feature'`
4. **Push** в branch: `git push origin feature/amazing-feature`  
5. Откройте **Pull Request**

### Code Style

```bash
# Линтинг
npm run lint        # ESLint проверка
npm run lint:fix    # Автоисправление

# Форматирование  
npm run prettier    # Prettier форматирование
```

### Полезные команды

```bash
# Перезапуск только сервера
cd server && node index.js

# Перезапуск только клиента  
npm start

# Полный перезапуск обоих серверов
npm run start:all

# Сборка для production
npm run build

# Preview production сборки  
npm run preview

# Остановка всех серверов
lsof -ti:3000,3001 | xargs kill -9
```

---

## 📈 Дорожная карта

### Ближайшие планы (Q4 2025)

🔴 **P0 - Критические исправления**
- [ ] Переход на httpOnly cookies для JWT
- [ ] Добавление rate limiting  
- ✅ ~~Интеграция смет заказчика с фронтендом~~ *(Завершено: блочное копирование и управление через localStorage)*
- ✅ ~~Тестирование всех новых API эндпоинтов~~ *(Завершено: все функции протестированы)*

🟡 **P1 - Важные улучшения** 
- [ ] Рефакторинг монолитного server.js (1,296 строк)
- [ ] Экспорт смет в Excel/PDF формат
- ✅ ~~Копирование смет между системами~~ *(Завершено: автоматическое копирование блоками)*
- [ ] Уведомления об изменениях смет
- [ ] API документация (OpenAPI/Swagger)

### Долгосрочные цели (2026)

🟢 **P2 - Стратегические инициативы**
- [ ] TypeScript миграция
- [ ] Performance оптимизация  
- [ ] Mobile приложение
- [ ] Интеграция с внешними системами

---

## ❓ FAQ

<details>
<summary><strong>Как создать смету заказчика?</strong></summary>

**Способ 1: Создание с нуля**
1. Перейдите в раздел "Расчеты" → "Смета заказчика"
2. Нажмите "Создать новую смету"
3. Выберите проект и заполните основные данные
4. Добавьте элементы сметы (работы/материалы)
5. Настройте коэффициенты при необходимости
6. Сохраните смету

**Способ 2: Копирование из расчета сметы (Новое!)**
1. Создайте смету заказчика (она станет активной)
2. Перейдите во вкладку "Расчет сметы"
3. Нажмите кнопку "Копировать в смету заказчика" на любом блоке
4. Данные автоматически скопируются блоками (работа + материалы) в активную смету
5. Система сохраняет группировку блоков и порядок элементов

API для создания:
```bash
POST /api/customer-estimates
{
  "project_id": "uuid",
  "name": "Название сметы",
  "description": "Описание",
  "coefficients": {"region": 1.2, "difficulty": 1.1}
}
```
</details>

<details>
<summary><strong>Как настроить параметры объекта?</strong></summary>

1. Откройте проект в разделе "Проекты"
2. Перейдите на вкладку "Параметры объекта"
3. Заполните основные характеристики объекта
4. Добавьте помещения с размерами и назначением
5. Опишите конструктивные элементы
6. Настройте инженерные системы

Каждый модуль имеет свой API для программного управления данными.
</details>

<details>
<summary><strong>Какие роли пользователей поддерживаются?</strong></summary>

Система поддерживает 5 ролей с разными уровнями доступа:

- **super_admin**: Полный доступ ко всей системе
- **admin**: Управление организацией
- **project_manager**: Управление проектами и сметами
- **estimator**: Создание и редактирование смет
- **viewer**: Только просмотр данных

Роли настраиваются администратором через API или интерфейс управления пользователями.
</details>

<details>
<summary><strong>Как сбросить пароль?</strong></summary>

В текущей версии функция сброса пароля не реализована. Обратитесь к администратору системы для изменения пароля напрямую в базе данных.
</details>

<details>
<summary><strong>Почему frontend не подключается к backend?</strong></summary>

Проверьте:
1. Запущен ли backend сервер (должен быть на порту 3001)
2. Настройки CORS в server/index.js
3. Настройки proxy в vite.config.mjs (если используется)
4. Правильность JWT токена в localStorage
</details>

<details>
<summary><strong>Как добавить новый материал в каталог?</strong></summary>

Используйте страницу "Материалы" в разделе "Справочники" или добавьте напрямую через API:
```bash
POST /api/materials
{
  "name": "Название материала",
  "unit": "м²", 
  "unit_price": 150.00
}
```
</details>

---

## 📞 Поддержка

- **Issues:** [GitHub Issues](https://github.com/your-repo/issues)  
- **Documentation:** [Техническая документация](REPORT_SMETA360_20250928.md)
- **Wiki:** [Project Wiki](https://github.com/your-repo/wiki)

---

## 📄 Лицензия

Этот проект лицензирован под MIT License - см. файл [LICENSE](LICENSE) для деталей.

---

## 👥 Команда

- **Архитектор:** Анализ проведен 28 сентября 2025  
- **Tech Stack:** React 18, Node.js, PostgreSQL  
- **Status:** Development (не готов к production без P0 исправлений)

---

## 🎉 Последние обновления (30 сентября 2025)

### ✅ Система блочного копирования смет

**Новая функциональность:**
- **Автоматическое копирование блоками** - данные из "Расчет сметы" копируются в "Смета заказчика" с сохранением структуры блоков
- **Убраны модальные окна** - копирование происходит автоматически в активную смету
- **Группировка по reference_id** - корректное отображение работ и материалов как единых блоков  
- **localStorage управление** - система автоматически отслеживает активную смету между вкладками
- **Исправлены все ошибки API** - GET, POST, DELETE endpoints работают корректно

**Техническая реализация:**
- Добавлено поле `reference_id` для связывания элементов в блоки
- Переработана логика копирования в `estimate.jsx` и `customerEstimate.jsx`
- Исправлена аутентификация во всех API endpoints
- Добавлены обходы для тестирования с временным пользователем

---

*Последнее обновление: 30 сентября 2025*  
*Версия документации: 2.1* - Добавлена система блочного копирования смет
